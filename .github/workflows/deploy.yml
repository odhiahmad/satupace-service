name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Loka Kasir Service to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "===> üöÄ Deploying Loka Kasir Service"

            export PATH=$PATH:/usr/local/go/bin

            cd /home/ubuntu/loka-kasir-service || exit 1

            echo "===> üîÑ Pulling latest code..."
            git fetch --all
            git reset --hard origin/main
            git clean -fd

            echo "===> üß© Running go mod tidy..."
            /usr/local/go/bin/go mod tidy

            echo "===> ‚öôÔ∏è Building binary..."
            /usr/local/go/bin/go build -o loka-kasir main.go

            echo "===> üîê Updating sudoers rule for GitHub Actions..."
            echo 'ubuntu ALL=(ALL) NOPASSWD: /bin/systemctl restart loka-kasir' | sudo tee /etc/sudoers.d/github-actions > /dev/null

            echo "===> üîÅ Restarting Loka Kasir service..."
            sudo /bin/systemctl daemon-reload
            sudo /bin/systemctl restart loka-kasir

            echo "===> ‚è≥ Checking service status..."
            sleep 3
            STATUS=$(sudo systemctl is-active loka-kasir)
            if [ "$STATUS" != "active" ]; then
              echo "‚ùå Service failed to start."
              sudo systemctl status loka-kasir --no-pager
              exit 1
            fi

            echo "‚úÖ Service is running successfully!"
            sudo systemctl status loka-kasir --no-pager

      - name: Send Telegram Notification on Success
        if: success()
        run: |
          SERVICE_STATUS=$(ssh -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") -o StrictHostKeyChecking=no ubuntu@${{ secrets.VM_HOST }} "sudo systemctl is-active loka-kasir")
          if [ "$SERVICE_STATUS" = "active" ]; then
            MESSAGE="‚úÖ *Loka Kasir Service* berhasil dideploy & service aktif di VPS.\n\nüì¶ Commit: \`${{ github.sha }}\`\nüë§ By: \`${{ github.actor }}\`\nüîÅ Branch: \`${{ github.ref_name }}\`\nüü¢ Status: \`running\`"
          else
            MESSAGE="‚ö†Ô∏è *Loka Kasir Service* dideploy, tapi service *tidak aktif* setelah restart.\n\nüì¶ Commit: \`${{ github.sha }}\`\nüë§ By: \`${{ github.actor }}\`\nüîÅ Branch: \`${{ github.ref_name }}\`\nüî¥ Status: \`$SERVICE_STATUS\`"
          fi

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MESSAGE" \
            -d parse_mode=Markdown

      - name: Send Telegram Notification on Failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚ùå *Loka Kasir Service* gagal dideploy ke VPS.\n\nüì¶ Commit: \`${{ github.sha }}\`\nüë§ By: \`${{ github.actor }}\`\nüîÅ Branch: \`${{ github.ref_name }}\`\n\nü™µ Cek GitHub Actions log untuk detail error." \
            -d parse_mode=Markdown
